# Dockerfile文件简介

在上一篇文章中已经知道了Dockerfile的作用，以及一些用法。本文将对Dockerfile文件中一些核心的指令进行简要的阐述。

## FROM

每个镜像都是必须基于某个镜像进行构建的，而它的基镜像就是通过FROM指令来指定的。通常FROM都会作为Dockerfile文件中的第一个指令，它的基本语法如下。

```text
FROM <image>[:<tag>] [AS <name>]
```

比如下面就指定了基镜像是`ubuntu:18.10`，即ubuntu镜像的18.10版本。

```text
FROM ubuntu:18.10
```

按照官方的说法，一个Dockerfile文件中是可以有多个FROM指令的，每个FROM指令都是一个独立的stage，然后前面的stage创建的镜像可以作为后面的stage的依赖。

## COPY

COPY指令用来把源机器上的某个文件或目录复制到镜像中的某个目录下。它的语法有如下两种形式：

```text
COPY [--chown=<user>:<group>] <src>... <dest>
COPY [--chown=<user>:<group>] ["<src>",... "<dest>"] (this form is required for paths containing whitespace)
```

src是相当于当前构建镜像的目录而言的，比如当前构建镜像的目录是`/a`，然后有`/a/b1/c1`，如果想拷贝`/a/b1/c1`到镜像中的`/usr/hello`目录，则定义`COPY b1/c1 /usr/hello`，在容器中就会存在`/usr/hello/c1`文件。也可以定义`COPY b1 /usr/hello`，效果是一样的，因为当src是一个目录时，不会把该目录COPY到镜像中，而是会COPY该目录下的每一个文件到镜像中，但是目录下的子目录还是会COPY到镜像中。假设源机器上`/a1`的目录结构如下：

```text
├── b1
│   ├── c1
│   ├── dir1
│   │   └── dir11
│   │       └── dir111
│   │           └── file.txt
│   └── dir2
│       └── file.txt
```

可以看到它有子目录b1，b1下面又有文件c1，子目录dir1和dir2。当定义`COPY b1 /usr/hello`时，在镜像中将拥有如下目录结构。

```text
/usr
└── hello
    ├── c1
    ├── dir1
    │   └── dir11
    │       └── dir111
    │           └── file.txt
    └── dir2
        └── file.txt
```

从上面就可以看出COPY一个目录时不会连带当前目录一起COPY到镜像中，而是会COPY目录下的所有文件和目录到镜像中。COPY的是单个文件时则可以COPY该文件到镜像中。

src也可以使用通配符，其中`*`表示任意个任意字符，`?`表示任意单个字符。比如`COPY *.txt /usr/hello`表示拷贝当前目录下的所有txt文件到镜像中。

target除了可以指定绝对路径外，还可以是相对路径，它相对的是WORKDIR指令指定的路径。

```text
COPY test relativeDir/   # adds "test" to `WORKDIR`/relativeDir/
COPY test /absoluteDir/  # adds "test" to /absoluteDir/
```

> * src可以有多个，当有多个src时dest必须为一个目录。
> * 当dest可以是一个目录也可以是一个文件。当dest以`/`结尾时会被当作一个目录，或者dest本身就是指向一个目录时会被当作一个目录，此时src复制到dest后的路径将为`dest/src`。当dest没有以`/`结尾且不存在时将被当作一个文件，那么src在镜像中就会复制到dest，比如`COPY hello.html /usr/local/tomcat/webapps/ROOT/hello2.html`，那么源中的hello.html就对应镜像中的hello2.html。

## ADD

ADD指令的功能与COPY是类似的，它的两种语法如下。

```text
ADD [--chown=<user>:<group>] <src>... <dest>
ADD [--chown=<user>:<group>] ["<src>",... "<dest>"] (this form is required for paths containing whitespace)
```

ADD指令与COPY的区别在于ADD的src除了是文件外，还可以是一个URL，而COPY的src只能是文件。

## RUN


## WORKDIR


## USER


## VOLUME


## ENV
## ARG


## EXPOSE



## CMD

## ENTRYPOINT


更多指令及其用法请参考官方文档[https://docs.docker.com/engine/reference/builder/](https://docs.docker.com/engine/reference/builder/)